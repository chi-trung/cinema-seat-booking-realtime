<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cinema Booking - ƒê·∫∑t v√© xem phim Real-time</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="container">
        <div class="header-content">
          <div>
            <h1>üé¨ Cinema Booking System</h1>
            <p class="subtitle">
              ƒê·∫∑t v√© xem phim Real-time + Database + Authentication
            </p>
          </div>
          <div id="user-section" style="display: none" class="user-header">
            <div class="user-info">
              <span id="display-username"></span>
              <span id="display-role"></span>
            </div>
            <button onclick="logout()" class="btn-logout">ƒêƒÉng xu·∫•t</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container">
      <!-- ===== AUTHENTICATION SECTION ===== -->
      <section id="auth-section" class="card" style="display: none">
        <div class="auth-container">
          <!-- Tab Navigation -->
          <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">
              ƒêƒÉng nh·∫≠p
            </button>
            <button class="auth-tab" onclick="switchAuthTab('register')">
              ƒêƒÉng k√Ω
            </button>
          </div>

          <!-- Login Tab -->
          <div id="login-tab" class="auth-form active">
            <h2>ƒêƒÉng nh·∫≠p t√†i kho·∫£n</h2>
            <div class="form-group">
              <label>T√™n ƒëƒÉng nh·∫≠p:</label>
              <input
                type="text"
                id="login-username"
                placeholder="admin ho·∫∑c user1"
              />
            </div>
            <div class="form-group">
              <label>M·∫≠t kh·∫©u:</label>
              <input
                type="password"
                id="login-password"
                placeholder="admin123 ho·∫∑c user123"
              />
            </div>
            <button onclick="login()" class="btn-primary">ƒêƒÉng nh·∫≠p</button>
            <p class="hint">
              üí° T√†i kho·∫£n m·∫∑c ƒë·ªãnh: admin/admin123 ho·∫∑c user1/user123
            </p>
          </div>

          <!-- Register Tab -->
          <div id="register-tab" class="auth-form">
            <h2>T·∫°o t√†i kho·∫£n m·ªõi</h2>
            <div class="form-group">
              <label>T√™n ƒëƒÉng nh·∫≠p:</label>
              <input
                type="text"
                id="register-username"
                placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p"
              />
            </div>
            <div class="form-group">
              <label>Email:</label>
              <input
                type="email"
                id="register-email"
                placeholder="Nh·∫≠p email"
              />
            </div>
            <div class="form-group">
              <label>M·∫≠t kh·∫©u (t·ªëi thi·ªÉu 6 k√Ω t·ª±):</label>
              <input
                type="password"
                id="register-password"
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
              />
            </div>
            <button onclick="register()" class="btn-primary">ƒêƒÉng k√Ω</button>
          </div>
        </div>
      </section>

      <!-- ===== ADMIN UPLOAD SECTION ===== -->
      <section id="admin-section" class="card" style="display: none">
        <h2>üë®‚Äçüíº Qu·∫£n l√Ω phim (Admin)</h2>
        <div class="admin-form">
          <h3>Upload phim m·ªõi</h3>
          <div class="form-group">
            <label>T√™n phim:</label>
            <input type="text" id="upload-title" placeholder="Nh·∫≠p t√™n phim" />
          </div>
          <div class="form-group">
            <label>M√¥ t·∫£:</label>
            <textarea
              id="upload-description"
              placeholder="M√¥ t·∫£ phim"
              rows="2"
            ></textarea>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex: 1">
              <label>Ng√†y chi·∫øu:</label>
              <input type="date" id="upload-date" />
            </div>
            <div class="form-group" style="flex: 1">
              <label>Gi·ªù chi·∫øu:</label>
              <input type="time" id="upload-time" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex: 1">
              <label>R·∫°p:</label>
              <input
                type="text"
                id="upload-theater"
                placeholder="R·∫°p 1, 2, 3..."
              />
            </div>
            <div class="form-group" style="flex: 1">
              <label>Gi√° v√© (VNƒê):</label>
              <input type="number" id="upload-price" placeholder="100000" />
            </div>
          </div>
          <div class="form-group">
            <label>Poster (·∫£nh):</label>
            <input type="file" id="upload-poster" accept="image/*" />
            <small>H·ªó tr·ª£ JPG, PNG, WEBP (t·ªëi ƒëa 5MB)</small>
          </div>
          <button onclick="uploadMovie()" class="btn-primary">
            Upload phim
          </button>
        </div>
        <div id="admin-chat-section" style="display: none;">
            <h3>üí¨ Qu·∫£n l√Ω tin nh·∫Øn h·ªó tr·ª£ kh√°ch h√†ng</h3>
            <div style="display: flex; gap: 20px; margin-top: 15px;">
              <div style="flex: 1; border-right: 1px solid #ddd; padding-right: 15px;">
                <h4>Danh s√°ch cu·ªôc tr√≤ chuy·ªán</h4>
                <div style="position: relative; margin-bottom: 10px;">
                  <input type="text" id="conversation-search" placeholder="üîç T√¨m ki·∫øm kh√°ch h√†ng..." oninput="filterConversations()" style="width: 100%; padding: 8px 30px 8px 8px; border: 1px solid #ddd; border-radius: 5px;">
                  <button onclick="clearConversationSearch()" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #999; cursor: pointer; font-size: 18px; padding: 0 5px;" title="X√≥a">&times;</button>
                </div>
                <div id="admin-conversations-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px;">
                  <p style="text-align: center; color: #999;">ƒêang t·∫£i...</p>
                </div>
                <button onclick="requestConversationList()" style="width: 100%; margin-top: 10px; padding: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">L√†m m·ªõi danh s√°ch</button>
              </div>
              <div style="flex: 1;">
                <h4>Chi ti·∫øt cu·ªôc tr√≤ chuy·ªán</h4>
                <div id="admin-chat-messages" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px; background: #f9f9f9; margin-bottom: 10px;">
                  <p style="text-align: center; color: #999;">Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ xem</p>
                </div>
                <div style="display: flex; gap: 5px;">
                  <input type="text" id="admin-message-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeydown="handleAdminChatInput(event)" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                  <button onclick="sendAdminMessage()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">G·ª≠i</button>
                </div>
              </div>
            </div>
        </div>
      </section>

      <!-- ===== EDIT MOVIE MODAL ===== -->
      <div id="edit-modal" class="modal" style="display: none">
        <div class="modal-content">
          <div class="modal-header">
            <h2>‚úèÔ∏è S·ª≠a th√¥ng tin phim</h2>
            <button onclick="closeEditModal()" class="modal-close">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>T√™n phim:</label>
              <input type="text" id="edit-title" placeholder="Nh·∫≠p t√™n phim" />
            </div>
            <div class="form-group">
              <label>M√¥ t·∫£:</label>
              <textarea
                id="edit-description"
                placeholder="M√¥ t·∫£ phim"
                rows="2"
              ></textarea>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 1">
                <label>Ng√†y chi·∫øu:</label>
                <input type="date" id="edit-date" />
              </div>
              <div class="form-group" style="flex: 1">
                <label>Gi·ªù chi·∫øu:</label>
                <input type="time" id="edit-time" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 1">
                <label>R·∫°p:</label>
                <input
                  type="text"
                  id="edit-theater"
                  placeholder="R·∫°p 1, 2, 3..."
                />
              </div>
              <div class="form-group" style="flex: 1">
                <label>Gi√° v√© (VNƒê):</label>
                <input type="number" id="edit-price" placeholder="100000" />
              </div>
            </div>
            <div class="form-group">
              <label>Poster (·∫£nh - ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng thay ƒë·ªïi):</label>
              <input type="file" id="edit-poster" accept="image/*" />
              <small>H·ªó tr·ª£ JPG, PNG, WEBP (t·ªëi ƒëa 5MB)</small>
            </div>
            <div class="form-group">
              <label>Video intro phim:</label>
              <div
                id="current-video-info"
                style="
                  display: none;
                  background: #e8f5e9;
                  padding: 10px;
                  border-radius: 5px;
                  margin-bottom: 10px;
                "
              >
                <p style="margin: 0; color: #2e7d32">
                  ‚úì <strong>Video hi·ªán t·∫°i:</strong>
                  <span id="current-video-name"></span>
                </p>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #558b2f">
                  Ch·ªçn file m·ªõi ƒë·ªÉ thay th·∫ø video hi·ªán t·∫°i
                </p>
              </div>
              <input type="file" id="edit-intro-video" accept="video/*" />
              <small>H·ªó tr·ª£ MP4, WebM, OGG (t·ªëi ƒëa 100MB)</small>
              <div
                id="video-upload-progress"
                style="display: none; margin-top: 10px"
              >
                <div class="progress-bar">
                  <div id="upload-progress" class="progress-fill"></div>
                </div>
                <p
                  id="upload-status"
                  style="margin-top: 5px; font-size: 0.9rem"
                ></p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button onclick="closeEditModal()" class="btn-secondary">
              H·ªßy
            </button>
            <button onclick="saveEditedMovie()" class="btn-primary">
              L∆∞u thay ƒë·ªïi
            </button>
          </div>
        </div>
      </div>

      <!-- ===== VIDEO UPLOAD MODAL ===== -->
      <div id="video-upload-modal" class="modal" style="display: none">
        <div class="modal-content" style="width: 90%; max-width: 600px">
          <div class="modal-header">
            <h2>üé• Upload Video Demo Phim</h2>
            <button onclick="closeVideoUploadModal()" class="modal-close">
              &times;
            </button>
          </div>
          <div class="modal-body" style="padding: 20px">
            <div class="form-group">
              <label>Ch·ªçn file video:</label>
              <input
                type="file"
                id="video-file-input"
                accept="video/*"
                onchange="onVideoFileSelected(event)"
              />
              <small style="display: block; margin-top: 5px">
                H·ªó tr·ª£ MP4, WebM, OGG (t·ªëi ƒëa 100MB)
              </small>
              <div id="file-info" style="margin-top: 10px; display: none">
                <p><strong>File:</strong> <span id="file-name"></span></p>
                <p><strong>K√≠ch th∆∞·ªõc:</strong> <span id="file-size"></span></p>
              </div>
            </div>

            <div id="upload-controls" style="display: none; margin-top: 20px">
              <div class="progress-container" style="margin-bottom: 15px">
                <label style="display: block; margin-bottom: 8px">
                  Ti·∫øn tr√¨nh upload:
                </label>
                <div
                  class="progress-bar"
                  style="height: 30px; border-radius: 5px"
                >
                  <div
                    id="upload-progress-bar"
                    class="progress-fill"
                    style="
                      height: 100%;
                      border-radius: 5px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      color: white;
                      font-weight: bold;
                      transition: width 0.3s;
                    "
                  >
                    <span id="progress-text">0%</span>
                  </div>
                </div>
              </div>

              <div
                id="upload-details"
                style="
                  background: rgba(0, 0, 0, 0.3);
                  padding: 15px;
                  border-radius: 5px;
                  margin-bottom: 15px;
                  border: 1px solid rgba(255, 255, 255, 0.1);
                "
              >
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                    font-size: 0.9rem;
                  "
                >
                  <div>
                    <p style="margin: 0 0 5px 0; color: #aaa">Uploaded:</p>
                    <p
                      style="
                        margin: 0;
                        font-weight: bold;
                        color: #4caf50;
                        font-size: 1rem;
                      "
                      id="uploaded-size"
                    >
                      0 MB / 0 MB
                    </p>
                  </div>
                  <div>
                    <p style="margin: 0 0 5px 0; color: #aaa">Speed:</p>
                    <p
                      style="
                        margin: 0;
                        font-weight: bold;
                        color: #4caf50;
                        font-size: 1rem;
                      "
                      id="upload-speed"
                    >
                      0 MB/s
                    </p>
                  </div>
                  <div>
                    <p style="margin: 0 0 5px 0; color: #aaa">Chunks:</p>
                    <p
                      style="
                        margin: 0;
                        font-weight: bold;
                        color: #4caf50;
                        font-size: 1rem;
                      "
                      id="chunks-info"
                    >
                      0 / 0
                    </p>
                  </div>
                  <div>
                    <p style="margin: 0 0 5px 0; color: #aaa">ETA:</p>
                    <p
                      style="
                        margin: 0;
                        font-weight: bold;
                        color: #4caf50;
                        font-size: 1rem;
                      "
                      id="time-remaining"
                    >
                      --:--
                    </p>
                  </div>
                </div>
              </div>

              <div
                id="upload-status-message"
                style="
                  padding: 10px;
                  border-radius: 5px;
                  margin-bottom: 15px;
                  display: none;
                "
              ></div>

              <div id="upload-buttons" style="display: flex; gap: 10px">
                <button
                  id="start-upload-btn"
                  onclick="startVideoUpload()"
                  class="btn-primary"
                  style="flex: 1"
                >
                  B·∫Øt ƒë·∫ßu Upload
                </button>
                <button
                  id="pause-upload-btn"
                  onclick="pauseVideoUpload()"
                  class="btn-secondary"
                  style="flex: 1; display: none"
                >
                  T·∫°m d·ª´ng
                </button>
                <button
                  id="cancel-upload-btn"
                  onclick="cancelVideoUpload()"
                  class="btn-secondary"
                  style="flex: 1"
                >
                  H·ªßy
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== CONNECTION STATUS ===== -->
      <div id="connection-status" class="status-bar">
        <span id="status-indicator">‚ö™</span>
        <span id="status-text">Ch∆∞a k·∫øt n·ªëi</span>
      </div>

      <!-- ===== MOVIES LIST SECTION ===== -->
      <section id="movies-section" class="card" style="display: none">
        <h2>üé• Danh s√°ch phim</h2>
        <div id="movies-list" class="movies-grid"></div>
      </section>

      <!-- ===== SEAT SELECTION SECTION ===== -->
      <section id="seats-section" class="card" style="display: none">
        <div class="seat-header">
          <div>
            <h2 id="selected-movie-title"></h2>
            <p id="selected-movie-info"></p>
          </div>
          <button onclick="goBackToMovies()" class="btn-secondary">
            ‚Üê Quay l·∫°i
          </button>
        </div>

        <!-- ===== VIDEO DEMO SECTION ===== -->
        <div id="video-demo-section" style="display: none; margin-bottom: 20px">
          <h3 style="margin-top: 0; margin-bottom: 10px">üé• Video Demo Phim</h3>
          <div
            style="
              background: rgba(0, 0, 0, 0.5);
              border-radius: 8px;
              overflow: hidden;
              border: 1px solid rgba(229, 9, 20, 0.3);
            "
          >
            <video
              id="demo-video-player"
              style="
                width: 100%;
                height: auto;
                max-height: 400px;
                background: #000;
                display: block;
              "
              controls
              controlsList="nodownload"
            ></video>
          </div>
        </div>

        <div class="screen">üé¨ M√ÄN H√åNH üé¨</div>

        <div id="seats-container" class="seats-container"></div>

        <div class="legend">
          <div class="legend-item">
            <div class="seat available"></div>
            <span>Tr·ªëng</span>
          </div>
          <div class="legend-item">
            <div class="seat selected"></div>
            <span>ƒêang ch·ªçn (b·∫°n)</span>
          </div>
          <div class="legend-item">
            <div class="seat booked"></div>
            <span>ƒê√£ ƒë·∫∑t</span>
          </div>
        </div>

        <div class="booking-info">
          <div class="booking-summary">
            <p>
              Gh·∫ø ƒë√£ ch·ªçn: <strong id="selected-count">0</strong> | T·ªïng ti·ªÅn:
              <strong id="total-price">0 VNƒê</strong>
            </p>
            <button
              onclick="confirmBooking()"
              class="btn-primary"
              id="confirm-btn"
              disabled
            >
              X√°c nh·∫≠n ƒë·∫∑t v√©
            </button>
          </div>
        </div>
      </section>

      <!-- ===== ACTIVITY LOG ===== -->
      <section class="card">
        <h2>üìä Ho·∫°t ƒë·ªông Real-time</h2>
        <div id="logs" class="logs-container"></div>
      </section>
    </main>

    <!-- ===== CHAT FEATURE ===== -->
    <div id="chat-widget" style="display: none;">
        <div id="chat-bubble" onclick="toggleChat()">
            üí¨
        </div>
        <div id="chat-window" style="display: none;">
            <div id="chat-header">
                H·ªó tr·ª£ kh√°ch h√†ng
                <button id="close-chat" onclick="toggleChat()">&times;</button>
            </div>
            <div id="chat-messages"></div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeydown="handleChatInput(event)">
                <button id="chat-send" onclick="sendChatMessage()">G·ª≠i</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="container">
        <p>üéì D·ª± √°n m√¥n L·∫≠p tr√¨nh m·∫°ng - H·ªá th·ªëng ƒë·∫∑t v√© xem phim Real-time</p>
        <p>
          Kh√°i ni·ªám: Client-Server | HTTP REST API | JWT Auth | WebSocket |
          SQLite Database
        </p>
      </div>
    </footer>

    <!-- Socket.IO Client Library -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Main App Script -->
    <script src="app.js"></script>

    <script>
      // Tab switching for auth
      function switchAuthTab(tab) {
        const tabs = document.querySelectorAll(".auth-tab");
        const forms = document.querySelectorAll(".auth-form");

        tabs.forEach((t) => t.classList.remove("active"));
        forms.forEach((f) => f.classList.remove("active"));

        event.target.classList.add("active");
        document.getElementById(tab + "-tab").classList.add("active");
      }

      // Auto-enable/disable confirm button
      function updateConfirmButton() {
        const btn = document.getElementById("confirm-btn");
        if (btn) {
          btn.disabled = selectedSeats.size === 0;
        }
      }

      // Override toggleSeat to update button
      const originalToggleSeat = toggleSeat;
      toggleSeat = function (seatId, status) {
        originalToggleSeat.call(this, seatId, status);
        updateConfirmButton();
      };
    </script>
  </body>
</html>
